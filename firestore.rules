/**
 * This ruleset is designed for the Eternal Echo application, which requires
 * proposals to be publicly shareable via a link.
 *
 * Core Philosophy:
 * Proposal data is public and read-only for viewers. Creation is restricted
 * to authenticated sessions (including anonymous users), and modifications
 * from the client are disallowed to preserve the integrity of the proposal.
 *
 * Data Structure:
 * - /proposals/{proposalId}: Contains public proposal details and image URLs.
 * - /proposals/{proposalId}/photos/{photoId}: Stores photos for a given proposal.
 * - /decision_history/{decisionHistoryId}: A write-only collection for logging user
 *   interactions for machine learning, accessible even to anonymous users.
 *
 * Key Security Decisions:
 * - Public Readability: Any user with a link can read documents in the `/proposals`
 *   collection and its subcollections. This is essential for the sharing feature.
 * - Authenticated Create: Only authenticated sessions can create new proposals. The app
 *   handles this by signing users in anonymously.
 * - Immutability: Update and delete operations on proposals and photos are disallowed
 *   from the client to prevent tampering.
 * - Write-Only Analytics: The `/decision_history` collection is a secure "drop box."
 *   Any user can create documents, but no one can read, update, or delete them.
 * - List Prevention: Listing the entire `/proposals` collection is disallowed to prevent
 *   enumeration of all proposals created in the app.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for reusable logic
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * On create, validates that the proposal document's internal `id` field
     * matches the document ID from the path.
     */
    function isProposalDataValidForCreate(proposalId) {
      let data = request.resource.data;
      return data.id == proposalId;
    }
    
    /**
     * On create, validates that the photo document's internal `id` and `proposalId`
     * fields match the document IDs from the path.
     */
    function isPhotoDataValidForCreate(proposalId, photoId) {
      let data = request.resource.data;
      return data.id == photoId && data.proposalId == proposalId;
    }

    /**
     * @description Secures public proposal documents.
     * @path        /proposals/{proposalId}
     * @allow       Anyone can (get) a proposal if they have the direct link (ID).
     * @allow       An authenticated user (incl. anonymous) can (create) a new proposal.
     * @deny        No one can (list) all proposals, preventing enumeration.
     * @deny        No one can (update) or (delete) a proposal from the client.
     * @principle   Enables the core sharing feature while protecting data integrity.
     */
    match /proposals/{proposalId} {
      allow get: if true;
      allow list: if false; // Prevent enumeration of all proposals
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;

      /**
       * @description Secures photo subcollections, making them publicly readable.
       * @path        /proposals/{proposalId}/photos/{photoId}
       * @allow       Anyone can (get) or (list) photos for a public proposal.
       * @deny        Client-side creation, update, and deletion of photos are disallowed.
       *              Photos should be created atomically with the proposal document.
       * @principle   Inherits public readability from the parent proposal.
       */
      match /photos/{photoId} {
        allow get: if true;
        allow list: if true;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }
    }
    
    /**
     * @description Secures the decision history collection used for machine learning.
     *              This collection acts as a "write-only" log or "drop box".
     * @path        /decision_history/{decisionHistoryId}
     * @allow       Any user, including anonymous ones, can (create) a new decision record.
     * @deny        Any user attempting to (get), (list), (update), or (delete) any record.
     * @principle   Allows for public data submission while preventing data leakage.
     */
    match /decision_history/{decisionHistoryId} {
      allow get: if false;
      allow list: if false;
      allow create: if true;
      allow update: if false;
      allow delete: if false;
    }
  }
}
